# @file
# @description
# This file provides some basic utility methods needed for uniform control of AntiMicroX.  
# AMX is not just used for keybindings for games that don't support controllers.
# It will also run when `batocera-emulationstation` is active, but with a minimal profile
# whose sole responsibility is to handle the `guide` button of the controller.  
# Therefore, basic start, stop and profile change functions are separate from `emulatorlauncher` 
# because they are also needed from the `emulationstation` wrapper script for OS-level integration.  
# requires:
# - `CONFIG_ROOT`
# - `XDG_RUNTIME_DIR`

_GUIDE_PROFILE="$CONFIG_ROOT"/batocera-emulationstation/controller-profiles/GUIDE.gamecontroller.amgp

# @description
# `emulatorlauncher` has to keep track of the PID of AntiMicroX instances it has started. 
# This function wraps the logic needed for that.
# - When no arg given: stdout current value
# - when numeric arg given: set/save as new PID
function _amx:pid {
  if [ -n "$1" ]; then
    echo -n "$1" > "$XDG_RUNTIME_DIR"/amx.state
  elif [ -f "$XDG_RUNTIME_DIR"/amx.state ]; then
    cat "$XDG_RUNTIME_DIR"/amx.state
  else
    # fallback in case there is no state file
    pgrep antimicrox || exit 1
  fi
}

# @description
# Make sure that AntiMicroX get's fully shut down and restarted again before the game.  
# **Reason:** It's also based on SDL, as such it must use the mappings as they are provided by batocera for consistency (if there are any).  
# But to achieve that, the `SDL_GAMECONTROLLERCONFIG` variable must be set when AMX launches.  
# Any arguments passed to this function will just be forwarded to AMX.
function _amx:restart {
  local id="$(_amx:pid)"
  [ 0 == "$?" ] && kill "$id"
  antimicrox "$@" &
  local pid="$!"
  _amx:pid "$pid"
}

# @description
# This function 'resets' the controller profile used back to default.  
# The default is a special profile called `GUIDE`, which is always active, even outside games.  
# It contains only one button mapping in the first set: the `guide` button. This button will do 2 things when pressed:
# 1. shift to a secondary set which emulates keyboard buttons for menu navigation
# 2. press the `SUPER_L` button (or manually call some menu-displaying command)
# 3. The menu must shift back the control set when closing (not implemented yet).
# TODO: `GUIDE` profile not implemented yet. 
function _amx:guideMode {
  _amx:restart \
    --hidden --tray \
    --profile "$_GUIDE_PROFILE"
}