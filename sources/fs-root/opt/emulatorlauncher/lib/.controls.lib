# @file
# This file handles configuration and visibility of input devices, primarily controllers.  
# Can only run after effective properties for a game have been loaded.

# @description 
# When property `hide_mouse` is set and `unclutter` is installed:  
# -> Add `_controls:startUnclutter` to `_PRE_RUN_OPERATIONS`
#
# When executed:
# -> fork out `unclutter`
# -> add kill for unclutter's pid to `POST_RUN_ACTIONS`
function _controls:startUnclutter {
  unclutter --timeout 1 --jitter 3 --ignore-scrolling --hide-on-key-press &
  _unclutter_pid="$!"
  _POST_RUN_ACTIONS+=("kill $_unclutter_pid")
  unset _unclutter_pid
}
if _isTrue "$hide_mouse" && _hasBin unclutter; then
  _PRE_RUN_OPERATIONS+=(_controls:startUnclutter)
fi

# @description
# Used to filter a `gamecontrollerdb.txt` according to the guids and names of controllers assigned to players.  
# This is a utility function meant to be used from the logic setting up the SDL configuration.
# 1. Requires variables `p[1-8]guid` and `p[1-8]name`
# 2. Constructs a pattern in grep extended regex format out of them
# 3. runs grep against stdin
# @stdin `gamecontrollerdb.txt` format
# @stdout grep result
function _filterControllerDB {
  local -A filters
  for p in p{1..8}; do
    id="${p}guid"
    name="${p}name"
    [ -n "${!id}" ] && filters["$id"]=true
    [ -n "${!name}" ] && filters["$name"]=true
  done
  unset p
  local fullFilter=$(_join \| "${!filters[@]}")
  grep -E "$fullFilter" -
}

case "$sdl_config" in
  db-global)
    _globalDB="$CONFIG_ROOT"/batocera-emulationstation/gamecontrollerdb.txt
    SDL_GAMECONTROLLERCONFIG="$(_filterControllerDB < "$_globalDB")"
    unset _globalDB
    ;;
  inherit)
    # do nothing of note here
    _logAndOut "use SDL_GAMECONTROLLERCONFIG from parent process"
    ;;
  none)
    unset SDL_GAMECONTROLLERCONFIG
    ;;
  external)
    if _hasBin es-sdl; then
      _sdl_strings=()
      for p in p{1..8}; do
        id="${p}guid"
        name="${p}name"
        [ "${!id}${!name}" = "" ] && continue
        _sdl_strings+=("$(es-sdl system="$system" game="$relativeRomPath" guid="${!id}" name="${!name}")")
      done
      unset p
      SDL_GAMECONTROLLERCONFIG="$(printf '%s\n' "${_sdl_strings[@]}")"
    fi
    ;;
  passthrough|*)
    # assume there is an array called batocera_sdl - will be provided by effectiveProperties
    # this is a pre-filtered list of sdl strings
    SDL_GAMECONTROLLERCONFIG="$(printf '%s\n' "${batocera_sdl[@]}")"
    ;;
esac
[ -n "$SDL_GAMECONTROLLERCONFIG" ] && export SDL_GAMECONTROLLERCONFIG

# NOTE: AMX controller profile is incompatible with multiplayer
controller_profile=${controller_profile:-none}
if [ "$controller_profile" != "none" ]; then
  _logAndOut "TBD: disable/block controller inputs from game"
fi
#TBD:
#1. look up property value as profile name
#2. if it doenst exist, try to find and/or create game/system/emu specific
