# @file
# @brief Generic shell utils for logging
# @description
# The functions declared here will generally write to stderr.
# This allows to capture and process the regular output, e.g. by using `$()`.
# 
# The log functions will not reset exit codes of the executing script to 0.

# requires a log file name
[ -z "$1" ] && exit 1

# don't re-init if it was set already
[ -z "$LOGFILE" ] || return 0

LOGFILE="$1"
mkdir -p "$(dirname "$LOGFILE")"

exec 3>"$LOGFILE"

_hasFunc _logOnly || \
function _logOnly {
  local RET="$?"
  if echo -e "$@" >&3; then return "$RET"; fi
}

_hasFunc _logAndOut || \
function _logAndOut {
  _logOnly "$@"
  local RET="$?"
  if echo -e "$@" >&2; then return "$RET"; fi
}

_hasFunc _logAndOutWhenDebug || \
function _logAndOutWhenDebug {
  local RET="$?"
  if [ -n "$PRINT_DEBUG" ]; then
    _logOnly "$@"
    if echo -e "$@" >&2; then return "$RET"; fi
  fi
  return "$RET"
}

_hasFunc _pipeDebugLog || \
function _pipeDebugLog {
  local RET="$?"
  if [ -n "$PRINT_DEBUG" ]; then
    if tee -a "$LOGFILE" >&2; then return "$RET"; fi
  else
    if cat >&3; then return "$RET"; fi
  fi
}

export -f _logOnly _logAndOut _logAndOutWhenDebug _pipeDebugLog